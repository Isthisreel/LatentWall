<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHAT DI U MEAN - Speech-to-Video</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            color: #888;
            font-size: 1.2em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
            color: #667eea;
        }

        #micButton {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 2.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            margin: 20px auto;
            display: block;
        }

        #micButton:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }

        #micButton.listening {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .status {
            text-align: center;
            margin-top: 15px;
            font-size: 1.1em;
            color: #888;
        }

        .status.active {
            color: #f5576c;
            font-weight: bold;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #555;
        }

        .dot.connected {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }

        .dot.error {
            background: #f87171;
        }

        .loading-mini {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-left: 5px;
        }

        #transcription {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            min-height: 150px;
            font-size: 1.5em;
            line-height: 1.6;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        #transcription.empty {
            color: #555;
            font-style: italic;
        }

        #logs {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .log-entry.success {
            border-left-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .log-entry.error {
            border-left-color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }

        .log-time {
            color: #888;
            font-size: 0.85em;
            margin-right: 10px;
        }

        #videoGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .video-container {
            position: relative;
            width: 150px;
            height: 266px;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid #667eea;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            margin: 0 auto 30px auto;
        }

        #liveVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            pointer-events: none;
        }

        .live-tag {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #f5576c;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8em;
            letter-spacing: 1px;
            display: none;
        }

        .live-tag.active {
            display: block;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .video-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .video-card:hover {
            transform: translateY(-5px);
        }

        .video-card video {
            width: 100%;
            border-radius: 10px;
            background: #000;
            margin-bottom: 10px;
        }

        .video-prompt {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 8px;
        }

        .video-status {
            font-size: 0.85em;
            color: #667eea;
            padding: 5px 10px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 5px;
            display: inline-block;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .vocabulary {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .vocabulary h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .word-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .word-tag {
            background: rgba(102, 126, 234, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            color: #aaa;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üé§ WHAT DI U MEAN</h1>
            <p class="tagline">Real-time Speech-to-Visual Translation</p>
            <div class="connection-status">
                <div class="dot" id="connDot"></div>
                <span id="connText">Backend: Connecting...</span>
                <span
                    style="margin-left: 15px; border: 1px solid #ff4757; background: rgba(255, 71, 87, 0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; color: #ff4757; font-weight: bold; box-shadow: 0 0 10px rgba(255, 71, 87, 0.2);">SUPER
                    TURBO ACTIVE (ULTRA-FAST NANO MODE)</span>
            </div>
        </header>

        <!-- Live Streaming Section -->
        <div class="video-container">
            <div class="live-tag" id="liveTag">LIVE STREAM</div>
            <canvas id="liveVideo"></canvas>
            <div class="video-overlay">
                <div id="transcription" class="empty">
                    Click the microphone and say something...
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Left: Microphone & Transcription -->
            <div class="panel">
                <h2>üó£Ô∏è Speech Input</h2>
                <button id="micButton">üé§</button>
                <div class="status" id="status">Click microphone to start</div>

                <div id="transcription" class="empty">
                    Your speech will appear here...
                </div>

                <div class="vocabulary">
                    <h3>Try saying:</h3>
                    <div class="word-list">
                        <span class="word-tag">cat</span>
                        <span class="word-tag">red car</span>
                        <span class="word-tag">big blue dragon</span>
                        <span class="word-tag">scary dark forest</span>
                        <span class="word-tag">happy yellow bird</span>
                    </div>
                </div>
            </div>

            <!-- Right: Logs -->
            <div class="panel">
                <h2>üìä Activity Log</h2>
                <div id="logs"></div>
            </div>
        </div>

        <!-- Bottom: Videos -->
        <div class="panel">
            <h2>üé¨ Generated Videos</h2>
            <div id="videoGrid"></div>
        </div>
    </div>

    <script>
        // State
        let isListening = false;
        let isStreaming = false;
        let recognition = null;
        let videoWs = null;

        // Elements
        const micButton = document.getElementById('micButton');
        const statusEl = document.getElementById('status');
        const transcriptionEl = document.getElementById('transcription');
        const logsEl = document.getElementById('logs');
        const videoGridEl = document.getElementById('videoGrid');
        const liveTag = document.getElementById('liveTag');
        const canvas = document.getElementById('liveVideo');
        const ctx = canvas.getContext('2d');

        // Initialize Web Speech API
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                        handleSpeech(finalTranscript.trim());
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                transcriptionEl.textContent = interimTranscript || finalTranscript;
                transcriptionEl.classList.remove('empty');
            };

            recognition.onerror = (event) => {
                addLog(`Mic error: ${event.error}`, 'error');
                stopSession();
            };

            recognition.onend = () => {
                if (isListening) recognition.start();
            };
        }

        // Initialize Web Status
        const connDot = document.getElementById('connDot');
        const connText = document.getElementById('connText');

        async function checkConnection() {
            try {
                // Try 127.0.0.1 if localhost fails
                const res = await fetch('http://localhost:8000/status');
                if (res.ok) {
                    connDot.className = 'dot connected';
                    connText.textContent = 'Backend: Connected';
                    return true;
                }
            } catch (err) {
                console.warn('Localhost check failed:', err);
            }
            connDot.className = 'dot error';
            connText.textContent = 'Backend: Disconnected';
            return false;
        }

        // WebSocket for Video
        function connectVideo() {
            const host = window.location.hostname || 'localhost';
            videoWs = new WebSocket(`ws://${host}:8000/ws/video`);

            videoWs.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'frame') {
                    renderFrame(message.data);
                    // If we receive a frame, we are definitely connected
                    if (connText.textContent !== 'Backend: Connected') {
                        connDot.className = 'dot connected';
                        connText.textContent = 'Backend: Connected';
                    }
                }
            };

            videoWs.onopen = () => {
                addLog('Video socket connected');
                checkConnection();
            };
            videoWs.onclose = () => {
                addLog('Video socket lost (Reconnecting...)', 'error');
                connDot.className = 'dot error';
                connText.textContent = 'Backend: Reconnecting...';
                setTimeout(connectVideo, 3000);
            };
            videoWs.onerror = (e) => {
                console.error('Socket error:', e);
                addLog('Socket error - check if backend is on port 8000', 'error');
            };
        }

        function renderFrame(base64Data) {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = 'data:image/jpeg;base64,' + base64Data;
        }

        // Mic Button Controls
        micButton.addEventListener('click', async () => {
            if (isListening) {
                await stopSession();
            } else {
                await startSession();
            }
        });

        async function startSession() {
            try {
                addLog('Starting interactive stream...');
                statusEl.innerHTML = '‚ö° INITIALIZING ODYSSEY... <div class="loading-mini"></div>';
                addLog('‚è≥ This typically takes 10-30 seconds to spin up the world model.', 'info');

                const response = await fetch('http://localhost:8000/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: 'abstract colorful organic flow', portrait: true })
                });

                if (response.ok) {
                    isStreaming = true;
                    isListening = true;
                    recognition.start();
                    micButton.classList.add('listening');
                    liveTag.classList.add('active');
                    statusEl.textContent = 'üî¥ STREAM ACTIVE - Speak Now';
                    addLog('‚úÖ Interactive stream started', 'success');
                } else {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Failed to start');
                }
            } catch (err) {
                addLog(`‚ùå Failed: ${err.message}`, 'error');
                statusEl.textContent = 'Error starting session';
            }
        }

        async function stopSession() {
            isListening = false;
            recognition.stop();
            micButton.classList.remove('listening');
            liveTag.classList.remove('active');
            statusEl.textContent = 'Stopping...';

            try {
                await fetch('http://localhost:8000/stream/end', { method: 'POST' });
                isStreaming = false;
                statusEl.textContent = 'Click microphone to start stream';
                addLog('Stream ended');
            } catch (err) {
                addLog(`Error ending stream: ${err.message}`, 'error');
            }
        }

        async function handleSpeech(text) {
            if (!text) return;
            addLog(`Speech: "${text}"`);

            try {
                const response = await fetch('http://localhost:8000/speech-to-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                const data = await response.json();
                if (data.status === 'streaming') {
                    addLog(`‚ú® Morphing to: ${data.prompt}`, 'success');
                } else if (data.job_id) {
                    addLog(`Job started: ${data.job_id.substring(0, 8)}`);
                }
            } catch (err) {
                addLog(`Interact error: ${err.message}`, 'error');
            }
        }

        function addVideoCard(jobId, prompt, originalText) {
            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `video-${jobId}`;
            card.innerHTML = `
                <div class="video-prompt">"${originalText}"</div>
                <div class="video-prompt" style="color: #667eea; font-style: italic;">${prompt}</div>
                <div class="video-status">‚è≥ Generating... <span class="loading"></span></div>
            `;

            videoGridEl.insertBefore(card, videoGridEl.firstChild);
            videos.set(jobId, { prompt, status: 'processing' });
        }

        async function pollVideo(jobId) {
            const maxAttempts = 60; // 60 seconds max
            let attempts = 0;

            const interval = setInterval(async () => {
                attempts++;

                try {
                    const response = await fetch(`http://localhost:8000/job/${jobId}`);
                    const data = await response.json();

                    if (data.status === 'completed' && data.video_url) {
                        clearInterval(interval);
                        updateVideoCard(jobId, data.video_url);
                        addLog(`‚úÖ Video ready for job ${jobId.substring(0, 8)}`, 'success');
                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        updateVideoCardError(jobId, data.error || 'Generation failed');
                        addLog(`‚ùå Video failed for job ${jobId.substring(0, 8)}`, 'error');
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        updateVideoCardError(jobId, 'Timeout waiting for video');
                        addLog(`‚è∞ Timeout for job ${jobId.substring(0, 8)}`, 'error');
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            }, 1000);
        }

        function updateVideoCard(jobId, videoUrl) {
            const card = document.getElementById(`video-${jobId}`);
            if (card) {
                const statusEl = card.querySelector('.video-status');
                statusEl.innerHTML = '‚úÖ Complete';

                const video = document.createElement('video');
                video.src = videoUrl;
                video.controls = true;
                video.autoplay = true;
                video.loop = true;

                card.appendChild(video);
            }
        }

        function updateVideoCardError(jobId, error) {
            const card = document.getElementById(`video-${jobId}`);
            if (card) {
                const statusEl = card.querySelector('.video-status');
                statusEl.innerHTML = `‚ùå ${error}`;
                statusEl.style.background = 'rgba(248, 113, 113, 0.2)';
                statusEl.style.color = '#f87171';
            }
        }

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span>${message}</span>
            `;

            logsEl.insertBefore(entry, logsEl.firstChild);

            // Keep only last 50 logs
            while (logsEl.children.length > 50) {
                logsEl.removeChild(logsEl.lastChild);
            }
        }

        // Initial log
        addLog('WHAT DI U MEAN ready! Click microphone to start.');

        // Start Connections
        checkConnection();
        connectVideo();
    </script>
</body>

</html>